---
title: Do cookie-free analytics need cookie compliance popups?
date: 2022-06-09
tags: ["analytics", "privacy"]
---

It might sound like a bit of a weird question: if we don't use cookies, surely there's no reason to ask users to... let us use cookies.

import { Image } from 'astro:assets';
import Figure from "../../../components/blog/Figure.astro";
import Aside from "../../../components/blog/Aside.astro";
import CookieImage from "./upgraded-jonathan-taylor-22GUPUuOqkE-unsplash.jpg";

<Figure>
  <Image alt="Photo showing cutouts of " inferSize src={CookieImage} />
  <figcaption class="left">Photo by [Jonathan Taylor](https://unsplash.com/@jontaylor?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash) on [Unsplash](https://unsplash.com/photos/brown-star-and-star-print-textile-22GUPUuOqkE?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash). Slightly enhanced for comedic effect.</figcaption>
</Figure>

When I recently reworked my personal website, I figured it'd be neat to see how many ~~days~~ ~~weeks~~ years it took between having visitors, just for my own curiosity. At the same time I wanted to avoid ugly banners, since they're an incredible eyesore (for the few users that don't block annoyances with uBlock Origin), and collecting data on visitors comes with all kinds of ethical concerns (if you're just some dude, at least -- big companies have it easy. Ethics are for non-capitalists).

That left me with the option of "privacy-aware analytics", a group of analytics solutions that _claim_ to do analytics without any of that Big Brother stuff. Oh, and as a plus, they let you do without those icky banner.

But... do they _actually_ let you track analytics without asking your users first? The following will be a dive into EU laws on "cookie popups" from the perspective of some dude who has no legal background, but too much time on his hands.

## Technical background

In recent years there has been an increased focus on online privacy and how our data is handled when we browse the web. This comes in the wake of the massively privacy-invading tracking done by companies like Google and Facebook becoming public knowledge, of EU legislation forcing companies to get informed consent before processing our data, and of better privacy tools becoming easily available in our browsers.

This has driven a heightened demand for "privacy-aware analytics", a term reserved for analytic solutions that aim to anonymize the collected data enough that it is no longer considered private data. An early example is [Fathom](https://usefathom.com/), but other (more or less) self-hosted solutions like [Plausible](https://plausible.io/), [Ackee](https://ackee.electerious.com/), and [Counter](https://counter.dev/) have also started popping up.

Privacy-aware analytics are faced with an obstacle: most analytics requires some way to recognize repeat visitors. Since HTTP is stateless, knowing whether a user has visited before (to count how many unique visitors we've had), visited another page (to calculate bounce rate), and when they left (to calculate average visit duration) requires some kind of user tracking.

Traditionally this has been done by storing a small token - in the form of a cookie, usually - on the user's device, which their browser then attaches to future requests. The analytics backend can then compare that to a list of previously seen tokens, and thereby know whether the user is new or has visited before.

---

Cookie-free analytics work slightly differently: instead of storing a small token on the user's device, the backend instead calculates a unique token when the request comes in based on the user's available data.

This process -- known as [fingerprinting](https://amiunique.org/) -- allows the analytics solution to skirt any legislation that limits when data can be stored on a user's device, and often works just as well as cookie-based tokens. Privacy-aware analytics usually combine this concept with a significant focus on privacy and extends it with things like hashing, rotating salts, and limited fingerprint data (for more information see [Fathom's great explainer](https://usefathom.com/blog/anonymization) on their algorithm). This generally produces what most people would consider anonymized data: in almost all situations it is impossible to trace any data back to the individual user, especially once the salt has been rotated.

While this implementation is enough to satisfy even me when it comes to respecting users' privacy, it also causes a common misconception: namely that since privacy-aware analytics solutions don't use cookies, implementors of them don't have to ask users for consent.

To work out whether that's true, we'll have to look at why we ask for consent in the first place.

## A bit of legal background

_Note: I am not a lawyer. The following is my simplistic understanding of the relevant legislation. Do not use it as legal advice._

When we're talking about analytics there are primarily two different EU laws we'll need to cover: the big baddie, GDPR, and the older cookie law, the ePrivacy Directive. These two both relate to data privacy and are often confused, so here's a quick breakdown:

<dl>
<dt><a href="https://eur-lex.europa.eu/eli/reg/2016/679/oj" target="_blank">GDPR [Regulation (EU) 2016/679]</a></dt>
<dd>Regulation adopted in 2016, came into force in 2018.<br/>Huge law primarily addressing the right of an individual to control their <em>personal data</em>. Trivial examples include names, birthdays, and emails; more complicated examples include browsing history, timestamps, and preferences. If there is any theoretical way that data can be traced back to a person, that data is probably covered by GDPR.<br/>GDPR is a huge beast and one that I am far from competent enough to cover. I will be assuming that the analytics solution you're looking to implement already strongly anonymizes all data, and therefore won't cover GDPR further.</dd>
<dt><a href="https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=celex%3A32002L0058">ePrivacy Directive [Directive 2002/58/EC]</a></dt>
<dd>Directive from 2002, later amended in 2009.<br/>One of the early attempts at legislating online privacy. Of interest to us is its regulations on what data can be processed for what uses without requiring informed consent from the user.<br/>Enforces privacy of any data read from a user's device, <em>personal or not</em>. This will be especially important for us, as it limits us greatly in what data we can use, even if we anonymize it heavily.<br/>Note that this is a directive, not a regulation, meaning it is up to the individual EU countries to implement the directive into law. This distinction isn't that important for our uses, and I will only be considering the wording of the directive itself in this article.</dd>
</dl>

<Aside>I might refer to the ePrivacy Directive by its informal name "the cookie law", or its shorthand "ePD", in the following text -- don't be confused though, it's still a directive, and it isn't particularly tied to cookies.</Aside>

We'll be focusing our efforts on the ePrivacy Directive, since (I believe) the consent required by GDPR can be largely skirted around by anonymizing data properly.

## Legal analysis
_Note: I still ain't no lawyer. Do not use the below as legal advice._

As put in [Article 5(3) of the ePrivacy Directive](https://eur-lex.europa.eu/legal-content/EN/TXT/HTML/?uri=CELEX:02002L0058-20091219#M2-9) (emphasis mine):

> [...] the storing of information, **or the gaining of access to information already stored**, in the terminal equipment of a subscriber or user is only allowed on condition that the subscriber or user concerned has given his or her consent [...]

This is where the ubiquitous cookie banners come from. Because the directive requires user consent before _even accessing_ data on a users device, and we usually need that for analytics, site owners are put in a bit of an awkward dilemma: do they just... _not_ track users, losing out on that sweet, sweet data that they need to raise their stock prices, or do they ask the users ~~manipulatively~~ nicely when they visit the site if they're allowed to track them? If you've used the internet in the last few years, you probably know the answer that most site owners choose.

Notably this article covers not just information in cookies, but also information in localStorage, and even (as we shall see later) information previously stored on the device by others, such as browser user agents. We therefore can't skirt the legislation by simply using other storage mechanisms, despite the unofficial "cookie law" misnomer. What a bummer. If we want to _store_ data on the user's device, we'll have to ask first -- and that's just too much for lil' ol' me.

---

Another notable thing is that the directive doesn't have any exceptions for anonymized data. As put by the EU Data Protection Working Party in [a 2014 opinion on anonymization](https://ec.europa.eu/justice/article-29/documentation/opinion-recommendation/files/2014/wp216_en.pdf):

> First, anonymisation is a technique applied to personal data in order to achieve irreversible de-identification. Therefore, the starting assumption is that the personal data must have been collected and processed in compliance with the applicable legislation on the retention of data in an identifiable format.

Not only can we not read user data from users without asking them nicely first, those buggers in the EU Data Protection Working Party don't even let us claim that our ethical high ground of anonymization makes us exempt.

## So... what is covered by the ePrivacy Directive?

Let's have a look at the various data points we can use to identify repeat visits, and what the ePrivacy Directive says about them:

<dl>
<dt>IP address or other traffic data</dt>
<dd>

Covered by [the Directive](https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=celex%3A32002L0058) in Article 26 (emphasis mine):

> (26) The data [...] processed within electronic communications networks to establish connections [...] may only be stored to the extent that is necessary for the provision of the service for the purpose of billing and for interconnection payments, and for a limited time. **Any further processing of such data [...] may only be allowed if the subscriber has agreed to this** on the basis of accurate and full information given by the provider [...] 

Since a user's IP address almost certainly falls under this category, we'll _also_ have to ask for informed consent before processing it for use in analytics. You can of course use still use the IP address for traffic purposes, but anything else requires informed consent.

Since things like GeoIP lookups use the IP address and therefore require accessing it first, using a user's country or city is also covered.

</dd>

<dt>Screen size, browser version and other client data</dt>
<dd>

Covered by the Directive as data that has previously been stored by the browser vendor or device manufacturer, which we then access. As put by the EU Data Protection Working Party in <a href="https://ec.europa.eu/justice/article-29/documentation/opinion-recommendation/files/2014/wp224_en.pdf">a 2014 opinion on fingerprinting</a>:

> Information that is stored by one party (including information stored by the user or device manufacturer) which is later accessed by another party is therefore within the scope of Article 5(3). [...] The consent requirement also applies when a read-only value is accessed (e.g. requesting the MAC address of a network interface via the OS API).

In the same opinion, they also cover the act of fingerprinting using HTTP headers, using the User-Agent header as an example, but do not specifically mention it as requiring informed consent.

</dd>
<dt>User-Agent, Referer, and other HTTP headers</dt>
<dd>

It could be argued that reading these headers isn't gaining access to data stored on the user's terminal equipment. However, these headers are specifically designed to allow tailoring of a response to the requester, and are sent for the purpose of allow the server to transmit the correct data (as described in <a href="https://httpwg.org/specs/rfc7231.html#header.user-agent">the specification</a>).

Since the ePrivacy Directive defines traffic data as being <em>"any data processed for the purpose of the conveyance of a communication on an electronic communications network or for the billing thereof"</em>, this means these HTTP headers probably also require informed consent to be processed.

</dd>

<dt>Any data stored by third parties (or us)</dt>
<dd>

This is trivially covered by Article 5(3) of the Directive, which we have covered already:

> [...] the storing of information, or the gaining of access to information already stored, in the terminal equipment of a subscriber or user is only allowed on condition that the subscriber or user concerned has given his or her consent [...]

As pointed out by the Working Party in the previously quoted [opinion on fingerprinting](https://ec.europa.eu/justice/article-29/documentation/opinion-recommendation/files/2014/wp224_en.pdf), this includes information stored by the user themselves or by device manufacturers - not to mention third parties. It blocks essentially all direct tracking, as it is intended to.

</dd>
</dl>

This leaves us with very few, if any, data points left to use for fingerprinting without asking the user for informed consent. While this is certainly a win for privacy when it comes to companies that are interested in finding loopholes that let them track users, it does extinguish any hope we have of escaping the popup nightmare the web has become today.

## Technical analysis

If we look at [the algorithm used by Fathom](https://usefathom.com/blog/anonymization), we see that it collects the following information for fingerprinting: IP address, user agent, site domain name, and site ID. Two of these can be accessed without relying on the user's device: the site domain and the site ID. The IP address and user agent, as we saw above, are explicitly covered by the ePrivacy Directive, and therefore require user consent to access. This means that even if we use Fathom analytics, despite its cookie-free and privacy-friendly design, we'll _still_ need a cookie banner to get user consent.

A similar story is true for [Plausible's algorithm](https://plausible.io/data-policy). It collects the following information: IP address, user agent, page URL, and referrer. Here the IP address, user agent, and referrer require consent according to the ePrivacy Directive, so we are in exactly the same boat as with Fathom: privacy-aware and cookie-free or not, a cookie popup is legally required. Even the people behind Plausible seem to be confused here, using (at the time of this writing) "No need for cookie banners or GDPR consent" as one of the titles on their landing page.

Every other privacy-aware analytics solution I've found, including [Ackee](https://github.com/electerious/Ackee/blob/master/docs/Anonymization.md) and [Counter](https://github.com/ihucos/counter.dev#how-can-it-be-free), also uses data covered by the ePrivacy Directive.

## So what _can_ we use cookies for?

Just because we cannot _track_ users using any sort of data without consent doesn't mean we need consent to use cookies. As put by article 5.3: _"[the restrictions] shall not prevent any technical storage or access for the sole purpose of carrying out the transmission of a communication over an electronic communications network, or as strictly necessary in order for the provider of an information society service explicitly requested by the subscriber or user to provide the service."_.

The first part, using stored or accessed data for the sole purpose of transmission, allows us to store information we may need to send information to the correct place (e.g. an assigned server when using load balancing). The second part, using stored or accessed data to service an explicit request by the user, allows us to use cookies for many of the common website tasks we have, such as tracking whether a user is logged in, what they have in their cart on e-commerce sites, and how far they've come in questionnaires.

For each of those cases it is important to notice that we _cannot_ use the information for anything other than the legitimate use outlined above: just because we use a cookie to track whether a user is logged in doesn't give us a free pass to also use that cookie for tracking purposes.

If you are interested in a more in-depth analysis of when these exemptions apply, the EU Data Protection Working Party released [an opinion on exemptions](https://ec.europa.eu/justice/article-29/documentation/opinion-recommendation/files/2012/wp194_en.pdf) in 2012 (with examples) where they delve deeper into it. I can highly recommend reading it. It even includes a specific analysis of first-party anonymized analytics, concluding that 

> While they are often considered as a 'strictly necessary' tool for website operators, they are not strictly necessary to provide a functionality explicitly requested by the user [...]. As a consequence, these cookies do not fall under the [exemptions]

(although the working group recommends that if Article 5(3) is revisited, an exemption for them could be granted -- this has not happened at the time of writing).

## Conclusion

Although it might come as a surprise (it certainly did for me), privacy-aware and cookie-free analytics aren't going to save us from cookie banners with the way the legislation is currently written.

If you are interested in avoiding cookie popups on your website, there, unfortunately, aren't any useful analytics solutions that will legally allow that. Like it or not, the cookie banners are here to stay.
